<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DetectorGraph: Templates</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DetectorGraph
   &#160;<span id="projectnumber">2.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Templates </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#template-intro">Introduction</a></li>
<li class="level1"><a href="#template-numbers">Numbers!</a></li>
<li class="level1"><a href="#less-templates">Other Optimization Opportunities</a></li>
<li class="level1"><a href="#finally">Conclusion</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="template-intro"></a>
Introduction</h1>
<dl class="section warning"><dt>Warning</dt><dd>This document is pretty out of date and is likely deprecated in some ways.</dd></dl>
<p>The framework relies extensibly on the use of <em>C++ Templates</em> and that raises the concern that it might result in <a href="https://en.wikipedia.org/wiki/Code_bloat">Code Bloat</a>. <em>C++ Templates</em> result in <em>Code Bloat</em> when a large block of code that would have been otherwise compiled into a single section of re-used machine code is duplicated per specialization of the template.</p>
<h1><a class="anchor" id="template-numbers"></a>
Numbers!</h1>
<p>This section provides a concrete rationale as an attempt to address those concerns.</p>
<p><a class="el" href="namespaceDetectorGraph.html">DetectorGraph</a> have the following templated classes:</p><ul>
<li><a class="el" href="classDetectorGraph_1_1Topic.html">Topic &lt;T&gt;</a></li>
<li><a class="el" href="classDetectorGraph_1_1Publisher.html">Publisher &lt;T&gt;</a></li>
<li><a class="el" href="classDetectorGraph_1_1SubscriberInterface.html">SubscriberInterface &lt;T&gt;</a></li>
<li><a class="el" href="classDetectorGraph_1_1FuturePublisher.html">FuturePublisher &lt;T&gt;</a></li>
<li><a class="el" href="classDetectorGraph_1_1TimeoutPublisher.html">TimeoutPublisher &lt;T&gt;</a></li>
<li><a class="el" href="classDetectorGraph_1_1SubscriptionDispatcher.html">SubscriptionDispatcher &lt;T&gt;</a></li>
<li><a class="el" href="classDetectorGraph_1_1GraphInputDispatcher.html">GraphInputDispatcher &lt;T&gt;</a></li>
</ul>
<p>and the following templated methods:</p><ul>
<li><a class="el" href="classDetectorGraph_1_1Detector.html#a9abf0258bd7bb4cd10040c44b778bd38">Detector::Subscribe &lt;T&gt;</a></li>
<li><a class="el" href="classDetectorGraph_1_1Detector.html#a9a1284378afa11798cb1c4e2111ab14e">Detector::SetupPublishing &lt;T&gt;</a></li>
<li><a class="el" href="classDetectorGraph_1_1Detector.html#af0e41ff6c1a8202a2a737fd42b8ed551">Detector::SetupFuturePublishing &lt;T&gt;</a></li>
<li><a class="el" href="classDetectorGraph_1_1Detector.html#a38fb4e6fcc8ead608ee1265b40524144">Detector::SetupTimeoutPublishing &lt;T&gt;</a></li>
<li><a class="el" href="classDetectorGraph_1_1Graph.html#aeab252a7ba121ea31750822bc0faf111">Graph::PushData &lt;T&gt;</a></li>
</ul>
<p>Each one of those constructs will be generated <em>once</em> for each type of <a class="el" href="structDetectorGraph_1_1TopicState.html" title="Base struct for topic data types. ">TopicState</a>. Below is an excerpt of the output of <em>nm</em> for a simple example:</p>
<div class="fragment"><div class="line">:~/$ nm -S --size-sort exminimal | grep -v St | grep AccelData</div><div class="line">00000000004053d2 0000000000000006 W _ZThn56_N11BarDetector8EvaluateERKN6DetectorGraph9AccelDataE</div><div class="line">000000000040a01c 000000000000000f W _ZN6DetectorGraph5TopicINS_9AccelDataEE13GetVertexTypeEv</div><div class="line">000000000040c0d0 0000000000000010 V _ZTIN6DetectorGraph19SubscriberInterfaceINS_9AccelDataEEE</div><div class="line">000000000040c410 0000000000000010 V _ZTIN6DetectorGraph9PublisherINS_9AccelDataEEE</div><div class="line">0000000000409f3a 0000000000000012 W _ZN6DetectorGraph22SubscriptionDispatcherINS_9AccelDataEE14GetTopicVertexEv</div><div class="line">000000000040c260 0000000000000014 V _ZTSN6DetectorGraph9AccelDataE</div><div class="line">0000000000405248 0000000000000015 W _ZN6DetectorGraph19SubscriberInterfaceINS_9AccelDataEEC1Ev</div><div class="line">0000000000405248 0000000000000015 W _ZN6DetectorGraph19SubscriberInterfaceINS_9AccelDataEEC2Ev</div><div class="line">0000000000405656 0000000000000015 W _ZN6DetectorGraph9PublisherINS_9AccelDataEEC1Ev</div><div class="line">0000000000405656 0000000000000015 W _ZN6DetectorGraph9PublisherINS_9AccelDataEEC2Ev</div><div class="line">000000000040bea0 0000000000000018 V _ZTIN6DetectorGraph22SubscriptionDispatcherINS_9AccelDataEEE</div><div class="line">000000000040bee0 0000000000000018 V _ZTIN6DetectorGraph5TopicINS_9AccelDataEEE</div><div class="line">000000000040c280 0000000000000018 V _ZTIN6DetectorGraph9AccelDataE</div><div class="line"><span class="preprocessor"># ...</span></div><div class="line">0000000000408a60 000000000000004e W _ZN6DetectorGraph9AccelDataC2ERKS0_</div><div class="line">0000000000405b86 0000000000000050 W _ZN6DetectorGraph5TopicINS_9AccelDataEE7PublishERKS1_</div><div class="line">00000000004056e6 0000000000000050 W _ZN6DetectorGraph8Detector15SetupPublishingINS_9AccelDataEEEvPNS_9PublisherIT_EE</div><div class="line">0000000000406184 0000000000000056 W _ZN6DetectorGraph12TopicRegistry7ResolveINS_5TopicINS_9AccelDataEEEEEPT_v</div><div class="line">00000000004061f4 000000000000005f W _ZN6DetectorGraph5TopicINS_9AccelDataEEC1Ev</div><div class="line">00000000004061f4 000000000000005f W _ZN6DetectorGraph5TopicINS_9AccelDataEEC2Ev</div><div class="line">0000000000405774 000000000000007a W _ZN6DetectorGraph8Detector9SubscribeINS_9AccelDataEEEvPNS_19SubscriberInterfaceIT_EE</div><div class="line">0000000000405af4 0000000000000092 W _ZN6DetectorGraph13Graph12ResolveTopicINS_9AccelDataEEEPNS_5TopicIT_EEv</div><div class="line">000000000040a592 00000000000000a4 W _ZN6DetectorGraph5TopicINS_9AccelDataEE22DispatchIntoSubscriberEPNS_19SubscriberInterfaceIS1_EE</div><div class="line">000000000040a02c 00000000000000b4 W _ZNK6DetectorGraph5TopicINS_9AccelDataEE21GetCurrentTopicStatesEv</div></div><!-- fragment --><p> As predicted, the compiler generates versions of many internal functions of the framework for each <code><a class="el" href="structDetectorGraph_1_1TopicState.html" title="Base struct for topic data types. ">TopicState</a></code> child. But how much code really is that? </p><div class="fragment"><div class="line">:~/$ nm -S exminimal | grep AccelData | gawk <span class="stringliteral">&#39;BEGIN {bytesPT=0} { bytesPT += strtonum(&quot;0x&quot;$2) } END {print bytesPT}&#39;</span></div><div class="line">5372</div></div><!-- fragment --><p> This shows that in total (and this includes the implementation of <code>AccelData</code> and of the <code>Evaluate</code> in that example) the code generated is around 5k.</p>
<p>But what's the split? One clue is to split what comes from STL and what comes from <a class="el" href="namespaceDetectorGraph.html">DetectorGraph</a>: </p><div class="fragment"><div class="line">:~/$ nm -S exminimal | grep -v St | grep AccelData | gawk <span class="stringliteral">&#39;BEGIN {bytesPT=0} { bytesPT += strtonum(&quot;0x&quot;$2) } END {print bytesPT}&#39;</span></div><div class="line">2783</div><div class="line">:~/$ nm -S exminimal | grep St | grep AccelData | gawk <span class="stringliteral">&#39;BEGIN {bytesPT=0} { bytesPT += strtonum(&quot;0x&quot;$2) } END {print bytesPT}&#39;</span></div><div class="line">2589</div></div><!-- fragment --><p> So basically, adding a new type to <a class="el" href="namespaceDetectorGraph.html">DetectorGraph</a> adds around the same amount of code than specializing a few STL templates (queue, list and a few iterators).</p>
<p>Another interesting thing to look at is the size of the optmized code generated by Poky: </p><div class="fragment"><div class="line">:~/$ make samples/minimal_crosscompile</div><div class="line">/opt/poky/1.6.2/sysroots/i686-pokysdk-linux/usr/bin/arm-poky-linux-gnueabi/arm-poky-linux-gnueabi-g++ -std=c++11 -O3 -g -I./include/ src/detectorgraph.cpp src/detector.cpp samples/minimal.cpp -o exminimal_crosscompile</div><div class="line">:~/$ nm -S exminimal_crosscompile | grep AccelData | gawk <span class="stringliteral">&#39;BEGIN {bytesPT=0} { bytesPT += strtonum(&quot;0x&quot;$2) } END {print bytesPT}&#39;</span></div><div class="line">1289</div></div><!-- fragment --><p>So finally we can conclude that adding a new version of <a class="el" href="classDetectorGraph_1_1Topic.html">Topic</a> and fully using it (Subscribe,Publish, etc) will add ~1.5k to the final compiler-optimized code. And this is without any code-size-optimizing changes to <a class="el" href="namespaceDetectorGraph.html">DetectorGraph</a>.</p>
<p>For example, the biggest contributor to the code bloat is <a class="el" href="classDetectorGraph_1_1Topic.html#a9902dccf5bef968887f820c0271e54b4">Topic::GetCurrentTopicStates()</a> : </p><div class="fragment"><div class="line">000000000040a02c 00000000000000b4 W _ZNK6DetectorGraph5TopicINS_9AccelDataEE21GetCurrentTopicStatesEv</div></div><!-- fragment --><p>Generated from: </p><div class="fragment"><div class="line"><span class="keyword">virtual</span> std::list&lt;const TopicState*&gt; GetCurrentTopicStates()<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">    std::list&lt;const TopicState*&gt; tCurrentTopicStates;</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span>(<span class="keyword">typename</span> std::list&lt;T&gt;::const_iterator valueIt = mCurrentValues.begin();</div><div class="line">            valueIt != mCurrentValues.end();</div><div class="line">            ++valueIt)</div><div class="line">    {</div><div class="line">        tCurrentTopicStates.push_back(&amp;(*valueIt));</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> tCurrentTopicStates;</div><div class="line">}</div></div><!-- fragment --><p>This could be easily moved out of <a class="el" href="classDetectorGraph_1_1Topic.html">Topic</a> since it's a convenience method (TODO(DGRAPH-20): If you ever feel geek-bored come fix this :D).</p>
<p>To give a bit of perspective here are a few numbers for the library part of both our graph libraries:</p>
<p>Current: </p><div class="fragment"><div class="line">:~/$ size libnldetector.so</div><div class="line">   text    data     bss     dec     hex filename</div><div class="line"> 115840    4360     200  120400   1d650 libnldetector.so</div></div><!-- fragment --><p><a class="el" href="namespaceDetectorGraph.html">DetectorGraph</a>: </p><div class="fragment"><div class="line">:~/$ size libnldetectorgraph.so</div><div class="line">  text    data     bss     dec     hex filename</div><div class="line"> 17153    1208       8   18369    47c1 libnldetectorgraph.so</div></div><!-- fragment --><p>But that's cheating a bit since it keeps out all templates out. Here's a functional example that offers the same set of functionalities: </p><div class="fragment"><div class="line">:~/$ size exminimal</div><div class="line">   text    data     bss     dec     hex filename</div><div class="line">  80076     808     576   81460   13e34 exminimal</div></div><!-- fragment --><h1><a class="anchor" id="less-templates"></a>
Other Optimization Opportunities</h1>
<p>The below internal classes could potentially be non-template classes:</p>
<ul>
<li><a class="el" href="classDetectorGraph_1_1SubscriptionDispatcher.html">SubscriptionDispatcher&lt;T&gt;</a></li>
<li><a class="el" href="classDetectorGraph_1_1GraphInputDispatcher.html">GraphInputDispatcher&lt;T&gt;</a></li>
</ul>
<p>Without changing any public API's. One way to achieve that could be to use <code>\:\:bind</code> to link it to the desired <code>PushData&lt;T&gt;</code> or <code><a class="el" href="classDetectorGraph_1_1SubscriberInterface.html" title="A Pure interface that declares the Subscriber behavior. ">SubscriberInterface</a>&lt;T&gt;\:\:Evaluate</code>.</p>
<h1><a class="anchor" id="finally"></a>
Conclusion</h1>
<p>Finally, after looking at all this here's our rationale:</p><ul>
<li>No complex, large or conditional logic is in the templated classes or methods.</li>
<li>Most of the templated code would otherwise be written by hand anyway and so it doesn't change much from our current graph.</li>
<li>Would code size ever become a real issue, many optimization opportunities are readily available since all templated types already have a common base class <a class="el" href="structDetectorGraph_1_1TopicState.html">TopicState</a> and could be applied at very little size cost. </li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
